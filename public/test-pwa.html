<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PWA - Trezu</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
</head>
<body>
    <h1>Teste PWA - Trezu</h1>
    <p>Esta p√°gina testa se o PWA est√° funcionando corretamente.</p>
    
    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
      <h3>üöÄ Teste de Instala√ß√£o</h3>
      <button id="installBtn" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 0;">
        Instalar PWA
      </button>
      <p id="installStatus" style="margin: 10px 0; font-weight: bold;"></p>
    </div>
    
    <h2>Verifica√ß√µes:</h2>
    <ul id="checks">
        <li>Carregando verifica√ß√µes...</li>
    </ul>
    
    <h2>Logs:</h2>
    <div id="logs" style="background: #f0f0f0; padding: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>
    
    <script>
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function addCheck(text, status) {
            const checksList = document.getElementById('checks');
            const li = document.createElement('li');
            li.textContent = text;
            li.style.color = status ? 'green' : 'red';
            checksList.appendChild(li);
        }
        
        // Verifica√ß√µes
        log('üîç Iniciando verifica√ß√µes PWA...');
        
        // 1. HTTPS
        const isHTTPS = window.location.protocol === 'https:';
        log(`üîí HTTPS: ${isHTTPS}`);
        addCheck(`HTTPS: ${isHTTPS}`, isHTTPS);
        
        // 2. Service Worker
        if ('serviceWorker' in navigator) {
            log('‚úÖ Service Worker suportado');
            addCheck('Service Worker suportado', true);
            
            navigator.serviceWorker.getRegistration().then(reg => {
                if (reg) {
                    log('‚úÖ Service Worker registrado');
                    addCheck('Service Worker registrado', true);
                } else {
                    log('‚ùå Service Worker n√£o registrado');
                    addCheck('Service Worker registrado', false);
                }
            });
        } else {
            log('‚ùå Service Worker n√£o suportado');
            addCheck('Service Worker suportado', false);
        }
        
        // 3. Manifest
        const manifestLink = document.querySelector('link[rel="manifest"]');
        if (manifestLink) {
            log('‚úÖ Manifest encontrado');
            addCheck('Manifest encontrado', true);
            
            fetch('/manifest.json')
                .then(response => response.json())
                .then(manifest => {
                    log('üìÑ Manifest carregado:', manifest);
                    addCheck('Manifest v√°lido', true);
                    
                    if (manifest.icons && manifest.icons.length > 0) {
                        log('‚úÖ √çcones encontrados no manifest');
                        addCheck('√çcones no manifest', true);
                        
                        manifest.icons.forEach(icon => {
                            log(`üì± √çcone: ${icon.src} (${icon.sizes})`);
                        });
                    } else {
                        log('‚ùå Nenhum √≠cone no manifest');
                        addCheck('√çcones no manifest', false);
                    }
                })
                .catch(error => {
                    log('‚ùå Erro ao carregar manifest:', error);
                    addCheck('Manifest v√°lido', false);
                });
        } else {
            log('‚ùå Manifest n√£o encontrado');
            addCheck('Manifest encontrado', false);
        }
        
        // 4. √çcones
        const icon192 = document.querySelector('link[href="/android-chrome-192x192.png"]');
        const icon512 = document.querySelector('link[href="/android-chrome-512x512.png"]');
        
        if (icon192) {
            log('‚úÖ √çcone 192x192 encontrado');
            addCheck('√çcone 192x192', true);
        } else {
            log('‚ùå √çcone 192x192 n√£o encontrado');
            addCheck('√çcone 192x192', false);
        }
        
        if (icon512) {
            log('‚úÖ √çcone 512x512 encontrado');
            addCheck('√çcone 512x512', true);
        } else {
            log('‚ùå √çcone 512x512 n√£o encontrado');
            addCheck('√çcone 512x512', false);
        }
        
        // 5. beforeinstallprompt
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            log('üéØ Evento beforeinstallprompt capturado!');
            e.preventDefault();
            deferredPrompt = e;
            addCheck('beforeinstallprompt dispon√≠vel', true);
        });
        
        // 6. Display mode
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        log(`üì± Display mode standalone: ${isStandalone}`);
        addCheck(`Display mode standalone: ${isStandalone}`, !isStandalone); // N√£o deve estar standalone para instala√ß√£o
        
        // 7. User Agent
        const userAgent = navigator.userAgent;
        log(`üåê User Agent: ${userAgent}`);
        
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
        log(`üì± Dispositivo m√≥vel: ${isMobile}`);
        addCheck(`Dispositivo m√≥vel: ${isMobile}`, true);
        
        // 8. Testar carregamento dos √≠cones
        function testIcon(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }
        
        Promise.all([
            testIcon('/android-chrome-192x192.png'),
            testIcon('/android-chrome-512x512.png')
        ]).then(([icon192Loaded, icon512Loaded]) => {
            log(`üì± √çcone 192x192 carregado: ${icon192Loaded}`);
            log(`üì± √çcone 512x512 carregado: ${icon512Loaded}`);
            addCheck('√çcones carregam corretamente', icon192Loaded && icon512Loaded);
        });
        
        // Verificar ap√≥s 3 segundos se beforeinstallprompt n√£o foi disparado
        setTimeout(() => {
            if (!deferredPrompt) {
                log('‚ö†Ô∏è beforeinstallprompt n√£o foi disparado ap√≥s 3 segundos');
                addCheck('beforeinstallprompt disparado', false);
            }
        }, 3000);
        
        // Bot√£o de instala√ß√£o
        const installBtn = document.getElementById('installBtn');
        const installStatus = document.getElementById('installStatus');
        
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                log('üéØ Tentando instalar PWA...');
                installStatus.textContent = 'Instalando...';
                installStatus.style.color = 'blue';
                
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        log('‚úÖ PWA instalado com sucesso!');
                        installStatus.textContent = '‚úÖ PWA instalado com sucesso!';
                        installStatus.style.color = 'green';
                    } else {
                        log('‚ùå PWA n√£o foi instalado (usu√°rio recusou)');
                        installStatus.textContent = '‚ùå Instala√ß√£o cancelada pelo usu√°rio';
                        installStatus.style.color = 'orange';
                    }
                } catch (error) {
                    log('‚ùå Erro durante instala√ß√£o:', error);
                    installStatus.textContent = '‚ùå Erro durante instala√ß√£o';
                    installStatus.style.color = 'red';
                }
            } else {
                log('‚ùå Nenhum prompt de instala√ß√£o dispon√≠vel');
                installStatus.textContent = '‚ùå Instala√ß√£o autom√°tica n√£o dispon√≠vel';
                installStatus.style.color = 'red';
            }
        });
        
        // Atualizar status do bot√£o
        if (deferredPrompt) {
            installBtn.textContent = 'Instalar PWA (Dispon√≠vel)';
            installBtn.style.background = '#4CAF50';
        } else {
            installBtn.textContent = 'Instala√ß√£o Manual';
            installBtn.style.background = '#ff9800';
        }
    </script>
</body>
</html> 